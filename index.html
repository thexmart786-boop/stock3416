<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Condis 3416 - Iron</title>
    <style>
        :root { --blue: #005696; --red: #e30613; }
        body { font-family: sans-serif; margin: 0; background: #f4f7f9; -webkit-tap-highlight-color: transparent; }
        
        header { background: var(--blue); color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center; position: sticky; top:0; z-index: 9999; }
        .menu-btn { font-size: 30px; padding: 10px; cursor: pointer; background: rgba(255,255,255,0.2); border-radius: 5px; width: 40px; text-align: center; }

        .sidenav { height: 100%; width: 0; position: fixed; z-index: 10000; top: 0; left: 0; background: #111; overflow-x: hidden; transition: 0.3s; padding-top: 60px; }
        .sidenav a { padding: 20px 25px; text-decoration: none; font-size: 22px; color: white; display: block; border-bottom: 1px solid #333; }

        .page { display: none; padding: 20px; text-align: center; }
        .active-page { display: block !important; }

        .btn-big { width: 100%; padding: 25px; background: var(--red); color: white; border: none; border-radius: 15px; font-size: 20px; font-weight: bold; margin-top: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        
        #video-container { width: 100%; height: 250px; background: #000; border-radius: 20px; overflow: hidden; margin-bottom: 10px; border: 2px solid var(--blue); }
        video { width: 100%; height: 100%; object-fit: cover; }

        .card { background: white; padding: 20px; border-radius: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); margin-top: 15px; }
        .qty-num { font-size: 60px; font-weight: bold; margin: 10px 0; color: #333; }
        .btn-round { width: 80px; height: 80px; border-radius: 50%; border: none; font-size: 35px; background: var(--blue); color: white; margin: 0 10px; }
        
        .stock-item { background: white; padding: 15px; border-radius: 10px; margin-bottom: 10px; border-left: 10px solid var(--blue); text-align: left; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
    </style>
</head>
<body>

<div id="mySidenav" class="sidenav">
  <a href="#" onclick="showPage('home'); return false;">üè† Home</a>
  <a href="#" onclick="showPage('scan'); return false;">üì∏ Scanner</a>
  <a href="#" onclick="showPage('stock'); return false;">üì¶ Stock List</a>
  <a href="#" onclick="closeNav(); return false;" style="color:var(--red)">CLOSE √ó</a>
</div>

<header>
    <div class="menu-btn" onclick="openNav()">‚ò∞</div>
    <span>CONDIS 3416</span>
    <div style="width:40px"></div>
</header>

<div id="home" class="page active-page">
    <div class="card" style="margin-top:50px;">
        <p>Current Database Items:</p>
        <h1 id="total-items">...</h1>
        <button class="btn-big" onclick="showPage('scan')">OPEN SCANNER</button>
    </div>
</div>

<div id="scan" class="page">
    <div id="video-container"><video id="video"></video></div>
    <div class="card">
        <div id="bc-text" style="color:#888; font-weight:bold;">READY TO SCAN</div>
        <div class="qty-num" id="qty-val">0</div>
        <div style="display:flex; justify-content:center;">
            <button class="btn-round" onclick="sync('update', -1)">-</button>
            <button class="btn-round" onclick="sync('update', 1)">+</button>
        </div>
        <p style="margin-top:20px; text-align:left; font-size:14px;">Expiry Date:</p>
        <input type="date" id="exp-date" onchange="saveExp()" style="width:100%; padding:15px; border-radius:10px; border:1px solid #ccc;">
    </div>
</div>

<div id="stock" class="page">
    <div id="stock-list"></div>
</div>

<script src="https://unpkg.com/@zxing/library@latest"></script>
<script>
    const URL = "https://epic-dory-42115.upstash.io";
    const TOKEN = "AaSDAAIncDIwYzlhNWU0ODUzZmQ0OWY0OGVlODE1NTg5NWRjOWIzNXAyNDIxMTU";
    const beep = new Audio("https://actions.google.com/sounds/v1/communication/notification_high_intensity.ogg");
    const reader = new ZXing.BrowserMultiFormatReader();
    let currentBC = null;

    function openNav() { document.getElementById("mySidenav").style.width = "280px"; }
    function closeNav() { document.getElementById("mySidenav").style.width = "0"; }

    function showPage(id) {
        // Force hide all pages
        document.getElementById('home').style.display = 'none';
        document.getElementById('scan').style.display = 'none';
        document.getElementById('stock').style.display = 'none';
        
        // Show the one we want
        document.getElementById(id).style.display = 'block';
        closeNav();

        if(id === 'scan') startScanner();
        else reader.reset();

        if(id === 'home') loadCount();
        if(id === 'stock') loadItems();
    }

    async function startScanner() {
        try {
            const devices = await reader.listVideoInputDevices();
            const deviceId = devices[devices.length - 1].deviceId;
            reader.decodeFromVideoDevice(deviceId, 'video', (res) => {
                if(res && res.text !== currentBC) {
                    currentBC = res.text;
                    document.getElementById('bc-text').innerText = "BARCODE: " + currentBC;
                    beep.play().catch(()=>{});
                    sync('get');
                }
            });
        } catch(e) { alert("Camera busy or blocked."); }
    }

    async function sync(type, val = 0) {
        if(!currentBC) return;
        let path = type === 'get' ? `/get/${currentBC}` : `/incrby/${currentBC}/${val}`;
        const res = await fetch(URL + path, { headers: { Authorization: `Bearer ${TOKEN}` } });
        const data = await res.json();
        document.getElementById('qty-val').innerText = data.result || 0;
        
        // Get date
        const dRes = await fetch(`${URL}/get/date-${currentBC}`, { headers: { Authorization: `Bearer ${TOKEN}` } });
        const dData = await dRes.json();
        document.getElementById('exp-date').value = dData.result || "";
    }

    async function saveExp() {
        if(!currentBC) return;
        const d = document.getElementById('exp-date').value;
        await fetch(`${URL}/set/date-${currentBC}`, { method: 'POST', headers: { Authorization: `Bearer ${TOKEN}` }, body: d });
    }

    async function loadCount() {
        const res = await fetch(`${URL}/keys/*`, { headers: { Authorization: `Bearer ${TOKEN}` } });
        const keys = (await res.json()).result || [];
        const items = keys.filter(k => !k.includes('date-') && !k.includes('img-'));
        document.getElementById('total-items').innerText = items.length;
    }

    async function loadItems() {
        const list = document.getElementById('stock-list');
        list.innerHTML = "Syncing with Database...";
        const res = await fetch(`${URL}/keys/*`, { headers: { Authorization: `Bearer ${TOKEN}` } });
        const keys = (await res.json()).result.filter(k => !k.includes('date-') && !k.includes('img-'));
        
        let html = "";
        for(let k of keys) {
            const v = (await (await fetch(`${URL}/get/${k}`, { headers: { Authorization: `Bearer ${TOKEN}` } })).json()).result;
            html += `<div class="stock-item"><b>${k}</b><br>Stock: ${v}</div>`;
        }
        list.innerHTML = html || "No stock found.";
    }

    window.onload = loadCount;
</script>
</body>
</html>