<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Condis 3416 - Emergency Fix</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
    <style>
        :root { --condis-blue: #005696; --condis-red: #e30613; }
        body { font-family: sans-serif; margin: 0; background: #f4f7f9; text-align: center; }
        
        /* HEADER */
        header { background: var(--condis-blue); color: white; padding: 15px; font-weight: bold; }

        /* THE SCANNER BOX - Simplified */
        #interactive.viewport { 
            width: 100%; height: 250px; background: #000; 
            position: relative; overflow: hidden;
        }
        video { width: 100%; height: 100%; object-fit: cover; }
        
        /* GREEN LINE TO HELP WORKERS SCAN */
        .laser { 
            position: absolute; top: 50%; left: 10%; right: 10%; 
            height: 2px; background: #00ff00; box-shadow: 0 0 10px #00ff00; 
            z-index: 10; pointer-events: none;
        }

        .card { background: white; padding: 20px; margin: 10px; border-radius: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .qty { font-size: 80px; font-weight: bold; color: var(--condis-blue); margin: 10px 0; }
        
        button { padding: 15px; border-radius: 10px; border: none; font-weight: bold; cursor: pointer; }
        .btn-camera { background: var(--condis-red); color: white; width: 90%; margin: 10px 0; font-size: 18px; }
        .btn-qty { background: var(--condis-blue); color: white; width: 80px; height: 80px; border-radius: 50%; font-size: 35px; }
    </style>
</head>
<body>

<header>CONDIS 3416 - INVENTORY</header>

<div id="interactive" class="viewport">
    <div class="laser"></div>
</div>

<button class="btn-camera" onclick="startScanner()">ðŸ”´ START CAMERA & SOUND</button>

<div class="card">
    <p id="display-bc" style="color: #888;">WAITING FOR SCAN...</p>
    <div class="qty" id="qty-display">0</div>
    
    <div style="display:flex; justify-content:center; gap:20px;">
        <button class="btn-qty" onclick="changeQty(-1)">âˆ’</button>
        <button class="btn-qty" onclick="changeQty(1)">+</button>
    </div>
</div>

<script>
    const url = "https://epic-dory-42115.upstash.io"; 
    const token = "AaSDAAIncDIwYzlhNWU0ODUzZmQ0OWY0OGVlODE1NTg5NWRjOWIzNXAyNDIxMTU"; 
    let activeBC = null;
    const beep = new Audio("https://www.soundjay.com/buttons/beep-07a.mp3");

    function startScanner() {
        // Stop any running camera first to prevent "black screen"
        Quagga.stop();

        // Unlock sound for iPhone
        beep.play().then(() => { beep.pause(); beep.currentTime = 0; });

        Quagga.init({
            inputStream: {
                name: "Live",
                type: "LiveStream",
                target: document.querySelector('#interactive'),
                constraints: { facingMode: "environment" } // Forces back camera
            },
            decoder: { readers: ["ean_reader", "upc_reader", "ean_8_reader"] }
        }, (err) => {
            if (err) {
                alert("CAMERA ERROR: Please go to settings and ALLOW camera for this website.");
                return;
            }
            Quagga.start();
        });
    }

    Quagga.onDetected((data) => {
        let code = data.codeResult.code;
        if (activeBC === code) return;
        
        activeBC = code;
        beep.play();
        document.getElementById('display-bc').innerText = "BARCODE: " + code;
        sync('get');
    });

    async function sync(type, val = 0) {
        if(!activeBC) return;
        let endpoint = type === 'get' ? `${url}/get/${activeBC}` : `${url}/incrby/${activeBC}/${val}`;
        const res = await fetch(endpoint, { headers: { Authorization: `Bearer ${token}` } });
        const data = await res.json();
        document.getElementById('qty-display').innerText = data.result || 0;
    }

    function changeQty(n) { if(activeBC) sync('update', n); else alert("Scan something first!"); }
</script>

</body>
</html>