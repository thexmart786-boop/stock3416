<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Condis 3416 - Dual Stock</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; text-align: center; background: #f0f2f5; padding: 10px; margin: 0; }
        .box-container { background: white; padding: 20px; border-radius: 15px; max-width: 450px; margin: auto; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        
        #interactive.viewport { width: 100%; height: 200px; background: #000; border-radius: 12px; overflow: hidden; position: relative; }
        #interactive.viewport::after { content: ""; position: absolute; top: 20%; left: 10%; right: 10%; bottom: 20%; border: 2px solid #005696; pointer-events: none; }
        video { width: 100%; height: 100%; object-fit: cover; }

        .qty-box { font-size: 80px; font-weight: bold; margin: 5px 0; color: #005696; }
        .label-text { font-size: 18px; color: #666; font-weight: bold; text-transform: uppercase; }
        
        .control-panel { display: flex; align-items: center; justify-content: space-between; margin-top: 20px; gap: 10px; }
        .side-btn { background: #005696; color: white; border: none; border-radius: 15px; width: 75px; height: 75px; font-size: 40px; cursor: pointer; }
        
        .center-selector { flex-grow: 1; display: flex; flex-direction: column; gap: 8px; }
        .type-btn { padding: 15px; border: 2px solid #ddd; border-radius: 10px; background: white; font-weight: bold; color: #888; cursor: pointer; font-size: 16px; }
        .type-btn.active { border-color: #005696; background: #eef6fc; color: #005696; border-width: 3px; }

        input[type="number"] { padding: 12px; width: 90%; border-radius: 8px; border: 1px solid #ccc; margin-top: 15px; font-size: 16px; }
        #status { font-size: 12px; color: #888; margin-top: 5px; }
    </style>
</head>
<body>
<div class="box-container">
    <h2 style="color:#005696; margin:0 0 10px 0;">CONDIS 3416</h2>
    
    <div id="interactive" class="viewport"></div>
    <button onclick="startScanner()" style="width:100%; background:#e30613; color:white; padding:10px; border-radius:8px; border:none; font-weight:bold; margin-bottom:10px;">ACTIVATE CAMERA & SOUND</button>
    
    <input type="number" id="manual-bc" placeholder="Enter Barcode..." onchange="handleManual()">

    <p id="prod-id" style="margin-top:15px; color:#888;">ID: None</p>
    <div class="label-text" id="current-mode-label">ITEMS</div>
    <div class="qty-box" id="prod-qty">0</div>
    
    <div class="control-panel">
        <button class="side-btn" onclick="adjust(-1)">‚àí</button>
        <div class="center-selector">
            <button id="btnBox" class="type-btn" onclick="setTarget('box')">üì¶ BOX</button>
            <button id="btnItem" class="type-btn active" onclick="setTarget('item')">üõçÔ∏è ITEMS</button>
        </div>
        <button class="side-btn" onclick="adjust(1)">+</button>
    </div>

    <p id="status">Ready</p>

    <button style="width:100%; background:#333; color:white; padding:15px; border-radius:10px; margin-top:25px; border:none; font-weight:bold;" onclick="loadAllStock()">VIEW TOTAL INVENTORY</button>
    <div id="stock-body" style="margin-top:15px; text-align: left;"></div>
</div>

<script>
    const url = "https://epic-dory-42115.upstash.io"; 
    const token = "AaSDAAIncDIwYzlhNWU0ODUzZmQ0OWY0OGVlODE1NTg5NWRjOWIzNXAyNDIxMTU"; 
    let currentBC = null;
    let mode = 'item'; 

    // SOUND FIX: Using a reliable beep sound
    const beep = new Audio("https://www.soundjay.com/buttons/beep-07a.mp3");

    function setTarget(t) {
        mode = t;
        document.getElementById('btnBox').classList.toggle('active', t === 'box');
        document.getElementById('btnItem').classList.toggle('active', t === 'item');
        document.getElementById('current-mode-label').innerText = t === 'box' ? "BOXES" : "ITEMS";
        if(currentBC) updateUI('get');
    }

    function adjust(val) {
        if (!currentBC) return alert("Scan first!");
        updateUI('update', val);
    }

    // SCANNER FIX: Added better error handling and initialization
    function startScanner() {
        // Unlock sound (required by mobile browsers)
        beep.play().then(() => { beep.pause(); beep.currentTime = 0; });

        Quagga.init({
            inputStream: { 
                name: "Live", 
                type: "LiveStream", 
                target: document.querySelector('#interactive'), 
                constraints: { facingMode: "environment", width: 640, height: 480 } 
            },
            decoder: { readers: ["ean_reader", "upc_reader", "ean_8_reader"] },
            locate: true
        }, (err) => { 
            if (err) {
                document.getElementById('status').innerText = "Camera Error: " + err;
                return;
            }
            Quagga.start(); 
            document.getElementById('status').innerText = "Scanner & Sound Active";
        });
    }

    function handleManual() {
        currentBC = document.getElementById('manual-bc').value;
        document.getElementById('prod-id').innerText = "ID: " + currentBC;
        updateUI('get');
    }

    Quagga.onDetected((data) => {
        let code = data.codeResult.code;
        if (currentBC === code) return;
        
        beep.play(); // Play beep
        currentBC = code;
        document.getElementById('prod-id').innerText = "ID: " + currentBC;
        updateUI('get');
    });

    async function updateUI(action, val = 0) {
        const storageKey = `${currentBC}-${mode}`;
        let endpoint = action === 'get' ? `${url}/get/${storageKey}` : `${url}/incrby/${storageKey}/${val}`;
        
        try {
            document.getElementById('status').innerText = "Syncing...";
            const res = await fetch(endpoint, { headers: { Authorization: `Bearer ${token}` } });
            const data = await res.json();
            document.getElementById('prod-qty').innerText = data.result || 0;
            document.getElementById('status').innerText = "Synced";
        } catch (e) { 
            document.getElementById('status').innerText = "Cloud Error"; 
        }
    }

    async function loadAllStock() {
        const res = await fetch(`${url}/keys/*`, { headers: { Authorization: `Bearer ${token}` } });
        const keys = (await res.json()).result || [];
        let html = "<table style='width:100%; border-collapse:collapse;'>";
        for (let k of keys) {
            const v = await (await fetch(`${url}/get/${k}`, { headers: { Authorization: `Bearer ${token}` } })).json();
            html += `<tr style='border-bottom:1px solid #eee; padding:5px;'><td style='font-size:12px;'>${k}</td><td style='text-align:right;'><b>${v.result}</b></td></tr>`;
        }
        document.getElementById('stock-body').innerHTML = html + "</table>";
    }
</script>
</body>
</html>