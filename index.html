<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Condis 3416 - Fix</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
    <style>
        body { font-family: sans-serif; margin: 0; background: #000; color: white; text-align: center; }
        header { background: #005696; padding: 15px; font-weight: bold; }
        
        /* THE VIEWER */
        #interactive.viewport { 
            width: 100vw; height: 60vh; background: #222; 
            position: relative; overflow: hidden;
        }
        video { width: 100%; height: 100%; object-fit: cover; }
        
        .panel { background: white; color: #333; padding: 20px; border-top-left-radius: 20px; border-top-right-radius: 20px; min-height: 40vh; position: relative; margin-top: -20px; }
        .bc-tag { background: #eee; padding: 5px 10px; border-radius: 5px; font-family: monospace; }
        .qty { font-size: 80px; font-weight: bold; color: #005696; margin: 10px 0; }
        
        button { border: none; font-weight: bold; cursor: pointer; }
        .btn-start { background: #e30613; color: white; width: 80%; padding: 15px; border-radius: 10px; font-size: 18px; margin-bottom: 10px; }
        .btn-qty { background: #005696; color: white; width: 70px; height: 70px; border-radius: 50%; font-size: 30px; }
        
        #error-log { font-size: 12px; color: red; margin: 5px; background: rgba(255,0,0,0.1); }
    </style>
</head>
<body>

<header>CONDIS 3416 - REPAIR MODE</header>

<div id="interactive" class="viewport"></div>
<div id="error-log"></div>

<div class="panel">
    <button class="btn-start" onclick="repairCamera()">REPAIR & START CAMERA</button>
    <p><span class="bc-tag" id="bc-text">WAITING...</span></p>
    <div class="qty" id="qty-val">0</div>
    <div style="display:flex; justify-content:center; gap:20px;">
        <button class="btn-qty" onclick="changeQty(-1)">âˆ’</button>
        <button class="btn-qty" onclick="changeQty(1)">+</button>
    </div>
</div>

<script>
    const url = "https://epic-dory-42115.upstash.io"; 
    const token = "AaSDAAIncDIwYzlhNWU0ODUzZmQ0OWY0OGVlODE1NTg5NWRjOWIzNXAyNDIxMTU"; 
    let activeBC = null;
    const beep = new Audio("https://www.soundjay.com/buttons/beep-07a.mp3");

    async function repairCamera() {
        document.getElementById('error-log').innerText = "Requesting Access...";
        try {
            // STEP 1: Force the browser to show the "Allow" popup
            const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
            stream.getTracks().forEach(track => track.stop()); // Stop it immediately so Quagga can take over
            
            // STEP 2: Start Quagga
            initQuagga();
        } catch (e) {
            document.getElementById('error-log').innerText = "ERROR: " + e.message;
        }
    }

    function initQuagga() {
        Quagga.init({
            inputStream: {
                name: "Live",
                type: "LiveStream",
                target: document.querySelector('#interactive'),
                constraints: { facingMode: "environment" }
            },
            decoder: { readers: ["ean_reader", "upc_reader"] }
        }, function(err) {
            if (err) {
                document.getElementById('error-log').innerText = "Quagga Error: " + err;
                return;
            }
            document.getElementById('error-log').innerText = "";
            Quagga.start();
        });
    }

    Quagga.onDetected((data) => {
        let code = data.codeResult.code;
        if (activeBC === code) return;
        activeBC = code;
        beep.play();
        document.getElementById('bc-text').innerText = code;
        sync('get');
    });

    async function sync(type, val = 0) {
        if(!activeBC) return;
        let endpoint = type === 'get' ? `${url}/get/${activeBC}` : `${url}/incrby/${activeBC}/${val}`;
        const res = await fetch(endpoint, { headers: { Authorization: `Bearer ${token}` } });
        const data = await res.json();
        document.getElementById('qty-val').innerText = data.result || 0;
    }

    function changeQty(n) { if(activeBC) sync('update', n); }
</script>

</body>
</html>